{% extends 'base.html' %}
{% load static %}

{% block title %}পণ্য/সেবা - নগরবাসী এক্সপ্রেস{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-center mb-3">
                <i class="fas fa-shopping-cart me-2"></i>পণ্য ও সেবা
            </h2>
            <p class="text-center text-muted">আপনার প্রয়োজনীয় সব কিছু এক জায়গায়</p>
        </div>
    </div>
    
    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="পণ্যের নাম দিয়ে খুঁজুন..." id="searchInput">
                <button class="btn btn-outline-primary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="categoryFilter">
                <option value="">সব বিভাগ</option>
                <option value="food">খাবার</option>
                <option value="medicine">ঔষধ</option>
                <option value="gas">গ্যাস</option>
                <option value="groceries">মুদি সামগ্রী</option>
                <option value="electronics">ইলেকট্রনিক্স</option>
                <option value="clothing">পোশাক</option>
                <option value="books">বই</option>
                <option value="other">অন্যান্য</option>
            </select>
        </div>
    </div>
    
    <!-- Category Filter Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-primary filter-btn active" data-filter="all">
                    <i class="fas fa-th-large me-1"></i>সব
                </button>
                <button class="btn btn-outline-primary filter-btn" data-filter="food">
                    <i class="fas fa-utensils me-1"></i>খাবার
                </button>
                <button class="btn btn-outline-primary filter-btn" data-filter="medicine">
                    <i class="fas fa-pills me-1"></i>ঔষধ
                </button>
                <button class="btn btn-outline-primary filter-btn" data-filter="gas">
                    <i class="fas fa-fire me-1"></i>গ্যাস
                </button>
                <button class="btn btn-outline-primary filter-btn" data-filter="groceries">
                    <i class="fas fa-shopping-bag me-1"></i>মুদি
                </button>
                <button class="btn btn-outline-primary filter-btn" data-filter="electronics">
                    <i class="fas fa-laptop me-1"></i>ইলেকট্রনিক্স
                </button>
                <button class="btn btn-outline-primary filter-btn" data-filter="clothing">
                    <i class="fas fa-tshirt me-1"></i>পোশাক
                </button>
                <button class="btn btn-outline-primary filter-btn" data-filter="books">
                    <i class="fas fa-book me-1"></i>বই
                </button>
            </div>
        </div>
    </div>
    
    <!-- Products Grid -->
    <div class="row" id="productsGrid">
        {% for product in products %}
        <div class="col-lg-4 col-md-6 mb-4 filterable-item" data-category="{{ product.category }}">
            <div class="card product-card h-100">
                {% if product.image %}
                <img src="{{ product.image.url }}" class="card-img-top product-image" alt="{{ product.name }}">
                {% else %}
                <div class="card-img-top product-image bg-light d-flex align-items-center justify-content-center">
                    <i class="fas fa-box fa-3x text-muted"></i>
                </div>
                {% endif %}
                
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <span class="badge bg-secondary">{{ product.get_category_display }}</span>
                    </div>
                    
                    <p class="card-text text-muted flex-grow-1">
                        {{ product.description|truncatechars:100 }}
                    </p>
                    
                    <div class="mt-auto">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 text-primary currency">৳ {{ product.price }}</span>
                            {% if product.is_available and product.stock_quantity > 0 %}
                                {% if product.stock_quantity <= 5 %}
                                    <span class="badge bg-warning">{{ product.get_stock_status }}</span>
                                {% else %}
                                    <span class="badge bg-success">{{ product.get_stock_status }}</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-danger">স্টক শেষ</span>
                            {% endif %}
                        </div>
                        
                        <!-- Stock Status Message -->
                        {% if product.stock_quantity == 0 %}
                            <div class="alert alert-danger py-2 mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <small>এই পণ্যটি স্টকে নেই</small>
                            </div>
                        {% elif product.stock_quantity <= 5 %}
                            <div class="alert alert-warning py-2 mb-3">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <small>শুধু {{ product.stock_quantity }}টি অবশিষ্ট</small>
                            </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2">
                            <a href="{% url 'orders:product_detail' product.pk %}" class="btn btn-primary">
                                <i class="fas fa-eye me-2"></i>বিস্তারিত দেখুন
                            </a>
                            {% if product.is_available and product.stock_quantity > 0 and not user.is_admin %}
                                <button class="btn btn-outline-success add-to-cart" data-product-id="{{ product.pk }}" data-product-name="{{ product.name }}" data-product-price="{{ product.price }}">
                                    <i class="fas fa-cart-plus me-2"></i>কার্টে যোগ করুন
                                </button>
                            {% elif user.is_admin %}
                                <div class="alert alert-info text-center py-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>অ্যাডমিন হিসেবে আপনি অর্ডার দিতে পারবেন না</small>
                                </div>
                            {% elif product.stock_quantity == 0 %}
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="fas fa-times me-2"></i>স্টক শেষ
                                </button>
                            {% elif not product.is_available %}
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="fas fa-times me-2"></i>অনুপলব্ধ
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-box fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">কোন পণ্য পাওয়া যায়নি</h4>
                <p class="text-muted">দয়া করে অন্য বিভাগ দেখুন বা খোঁজার শব্দ পরিবর্তন করুন</p>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="row">
        <div class="col-12">
            <nav aria-label="পণ্য পেজিনেশন">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Quick Order Modal -->
<div class="modal fade" id="quickOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">দ্রুত অর্ডার</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickOrderForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">পরিমাণ</label>
                        <input type="number" class="form-control" name="quantity" value="1" min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">বিশেষ নির্দেশনা</label>
                        <textarea class="form-control" name="special_instructions" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                <button type="button" class="btn btn-primary" id="confirmQuickOrder">অর্ডার করুন</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Search functionality
    $('#searchInput').on('keyup', function() {
        var searchTerm = $(this).val().toLowerCase();
        $('.filterable-item').each(function() {
            var productName = $(this).find('.card-title').text().toLowerCase();
            var productDesc = $(this).find('.card-text').text().toLowerCase();
            
            if (productName.indexOf(searchTerm) === -1 && productDesc.indexOf(searchTerm) === -1) {
                $(this).hide();
            } else {
                $(this).show();
            }
        });
    });
    
    // Category filter
    $('.filter-btn').on('click', function() {
        var filter = $(this).data('filter');
        
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        
        $('.filterable-item').each(function() {
            if (filter === 'all' || $(this).data('category') === filter) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // Add to cart functionality
    $('.add-to-cart').on('click', function() {
        var productId = $(this).data('product-id');
        $('#quickOrderModal').modal('show');
        $('#quickOrderForm').data('product-id', productId);
    });
    
    // Confirm quick order
    $('#confirmQuickOrder').on('click', function() {
        var productId = $('#quickOrderForm').data('product-id');
        var quantity = $('input[name="quantity"]').val();
        var instructions = $('textarea[name="special_instructions"]').val();
        
        // Add to cart functionality
        var productName = $('.add-to-cart[data-product-id="' + productId + '"]').closest('.card').find('.card-title').text();
        
        // Add to cart using localStorage
        var cart = JSON.parse(localStorage.getItem('cart')) || [];
        var existingItem = cart.find(function(item) {
            return item.id == productId;
        });
        
        if (existingItem) {
            existingItem.quantity += parseInt(quantity);
        } else {
            cart.push({
                id: productId,
                product_id: productId,
                name: productName,
                product_name: productName,
                price: $('.add-to-cart[data-product-id="' + productId + '"]').closest('.card').find('.currency').text().replace('৳', '').trim(),
                product_price: $('.add-to-cart[data-product-id="' + productId + '"]').closest('.card').find('.currency').text().replace('৳', '').trim(),
                quantity: parseInt(quantity)
            });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        addToCartNotification(productName, quantity);
        updateCartBadge();
        $('#quickOrderModal').modal('hide');
    });
});
</script>
{% endblock %}
