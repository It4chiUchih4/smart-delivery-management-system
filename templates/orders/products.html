{% extends 'base.html' %}
{% load static %}

{% block title %}‡¶™‡¶£‡ßç‡¶Ø ‡¶ì ‡¶∏‡ßá‡¶¨‡¶æ - ‡¶®‡¶æ‡¶ó‡¶∞‡ßÄ‡¶¨‡¶æ‡¶∏‡ßÄ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßç‡¶∞‡ßá‡¶∏{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-5">
                <i class="fas fa-shopping-bag me-2"></i>‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø ‡¶ì ‡¶∏‡ßá‡¶¨‡¶æ
            </h2>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-0">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</h5>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." onkeyup="searchProducts()">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="btn-group flex-wrap" role="group" id="category-filters" style="overflow-x: auto; white-space: nowrap;">
                                <button type="button" class="btn btn-outline-primary active" onclick="filterProducts('all')">‡¶∏‡¶¨</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('food')">‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('medicine')">‡¶î‡¶∑‡¶ß</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('gas')">‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('groceries')">‡¶Æ‡ßÅ‡¶¶‡¶ø ‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡ßÄ</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('electronics')">‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('clothing')">‡¶™‡ßã‡¶∂‡¶æ‡¶ï</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('books')">‡¶¨‡¶á</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterProducts('other')">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="row" id="products-container">
        {% if products %}
            {% for product in products %}
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4 product-item" data-category="{{ product.category }}">
                    <div class="card product-card h-100">
                        <div class="card-body text-center">
                            <div class="mb-3" style="font-size: 3rem;">
                                {% if product.category == 'food' %}üçó
                                {% elif product.category == 'medicine' %}üíä
                                {% elif product.category == 'gas' %}üî•
                                {% elif product.category == 'groceries' %}üõí
                                {% elif product.category == 'electronics' %}üì±
                                {% elif product.category == 'clothing' %}üëï
                                {% elif product.category == 'books' %}üìö
                                {% else %}üì¶{% endif %}
                            </div>
                            <h5 class="card-title product-name">{{ product.name }}</h5>
                            <p class="text-muted">{{ product.get_category_display }}</p>
                            <p class="text-muted small product-description">{{ product.description|truncatechars:50 }}</p>
                            <h4 class="text-primary">‡ß≥ {{ product.price }}</h4>
                            
                            <!-- Stock Status -->
                            {% if product.is_available and product.stock_quantity > 0 %}
                                {% if product.stock_quantity <= 5 %}
                                    <span class="badge bg-warning mb-2">{{ product.get_stock_status }}</span>
                                {% else %}
                                    <span class="badge bg-success mb-2">{{ product.get_stock_status }}</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-danger mb-2">‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑</span>
                            {% endif %}

                            {% if product.is_available and product.stock_quantity > 0 and not user.is_admin %}
                            <button class="btn btn-primary w-100 add-to-cart-btn" 
                                    data-product-id="{{ product.id }}"
                                    data-product-name="{{ product.name }}"
                                    data-product-price="{{ product.price }}">
                                <i class="fas fa-cart-plus me-2"></i>‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                            </button>
                            {% elif user.is_admin %}
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ
                            </div>
                            {% elif product.stock_quantity == 0 %}
                            <button class="btn btn-secondary w-100" disabled>
                                <i class="fas fa-times me-2"></i>‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑
                            </button>
                            {% elif not product.is_available %}
                            <button class="btn btn-secondary w-100" disabled>
                                <i class="fas fa-times me-2"></i>‡¶Ö‡¶®‡ßÅ‡¶™‡¶≤‡¶¨‡ßç‡¶ß
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">‡¶ï‡ßã‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</h4>
                <p class="text-muted">‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart me-2"></i>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cart-items">
                    <!-- Cart items will be loaded here -->
                </div>
                <div id="empty-cart" class="text-center py-5" style="display: none;">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø</h5>
                    <p class="text-muted">‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <a href="{% url 'orders:checkout' %}" class="btn btn-primary">
                    <i class="fas fa-credit-card me-2"></i>‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Products data from Django backend
    const products = [
        {% for product in products %}
        { 
            id: {{ product.id }}, 
            name: '{{ product.name|escapejs }}', 
            price: {{ product.price }}, 
            category: '{{ product.category|escapejs }}', 
            image: '{% if product.category == "food" %}üçó{% elif product.category == "medicine" %}üíä{% elif product.category == "gas" %}üî•{% elif product.category == "groceries" %}üõí{% else %}üì¶{% endif %}', 
            description: '{{ product.description|escapejs|truncatechars:50 }}' 
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateCartBadge();
        
        // Add event listeners for add to cart buttons
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                const productName = this.dataset.productName;
                const productPrice = parseFloat(this.dataset.productPrice);
                addToCart(productId, productName, productPrice);
            });
        });
        
        // Auto-refresh products every 30 seconds to show new products
        setInterval(function() {
            location.reload();
        }, 30000);
    });


    // Add to cart
    function addToCart(id, name, price) {
        let existingItem = cart.find(item => item.id == id);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ 
                id: id, 
                product_id: id,  // Add product_id for API compatibility
                name: name, 
                product_name: name,  // Add product_name for API compatibility
                price: price, 
                product_price: price,  // Add product_price for API compatibility
                quantity: 1 
            });
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        addToCartNotification(name, 1);
        updateCartBadge();
    }

    // Update cart badge
    function updateCartBadge() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const cartBadge = document.getElementById('cart-badge');
        if (cartBadge) {
            if (totalItems > 0) {
                cartBadge.textContent = totalItems;
                cartBadge.style.display = 'inline';
            } else {
                cartBadge.style.display = 'none';
            }
        }
    }

    // Filter products by category
    function filterProducts(category) {
        const productItems = document.querySelectorAll('.product-item');
        const filterButtons = document.querySelectorAll('.btn-group .btn');
        
        // Update active button
        filterButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.onclick && btn.onclick.toString().includes(`'${category}'`)) {
                btn.classList.add('active');
            }
        });
        
        // Filter products
        let visibleCount = 0;
        productItems.forEach(item => {
            const productCategory = item.getAttribute('data-category');
            
            if (category === 'all' || productCategory === category) {
                item.style.display = 'block';
                item.style.animation = 'fadeIn 0.3s ease-in';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show message if no products found
        if (visibleCount === 0 && category !== 'all') {
            const categoryNames = {
                'food': '‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞',
                'medicine': '‡¶î‡¶∑‡¶ß',
                'gas': '‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏',
                'groceries': '‡¶Æ‡ßÅ‡¶¶‡¶ø ‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡ßÄ',
                'electronics': '‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏',
                'clothing': '‡¶™‡ßã‡¶∂‡¶æ‡¶ï',
                'books': '‡¶¨‡¶á',
                'other': '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'
            };
            const categoryName = categoryNames[category] || category;
            showNotification(`‡¶ï‡ßã‡¶® ${categoryName} ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§`, 'info');
        }
    }
    
    // Search products
    function searchProducts() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const productItems = document.querySelectorAll('.product-item');
        
        let visibleCount = 0;
        productItems.forEach(item => {
            const productName = item.querySelector('.product-name').textContent.toLowerCase();
            const productDescription = item.querySelector('.product-description').textContent.toLowerCase();
            
            if (searchTerm === '' || productName.includes(searchTerm) || productDescription.includes(searchTerm)) {
                item.style.display = 'block';
                item.style.animation = 'fadeIn 0.3s ease-in';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show message if no products found
        if (visibleCount === 0 && searchTerm !== '') {
            showNotification(`"${searchTerm}" ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§`, 'info');
        }
    }
    
    // Clear search
    function clearSearch() {
        document.getElementById('search-input').value = '';
        // Reset all buttons
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        // Activate "All" button
        document.querySelector('.btn-group .btn[onclick*="all"]').classList.add('active');
        // Show all products
        document.querySelectorAll('.product-item').forEach(item => {
            item.style.display = 'block';
            item.style.animation = 'fadeIn 0.3s ease-in';
        });
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>

<style>
    .product-card {
        transition: transform 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .product-item {
        animation: fadeIn 0.3s ease-in;
    }
    
    .btn-group .btn.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
</style>
{% endblock %}
