{% extends 'base.html' %}
{% load static %}

{% block title %}ইনভয়েস - নাগরীবাসী এক্সপ্রেস{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>অর্ডার সফল!
                    </h4>
                </div>
                <div class="card-body">
                    <div id="invoice-content">
                        <!-- Invoice content will be loaded here by JavaScript -->
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary me-2" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>প্রিন্ট করুন
                        </button>
                        <a href="{% url 'orders:products' %}" class="btn btn-outline-primary">
                            <i class="fas fa-shopping-bag me-2"></i>আরও পণ্য দেখুন
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadInvoice();
    });

    function loadInvoice() {
        const orderData = JSON.parse(localStorage.getItem('currentOrder'));
        if (!orderData) {
            document.getElementById('invoice-content').innerHTML = '<p class="text-muted">কোন অর্ডার ডেটা পাওয়া যায়নি</p>';
            return;
        }

        const subtotal = orderData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const delivery = 50;
        const vat = Math.round(subtotal * 0.05);
        const processingFee = orderData.payment !== 'cod' ? Math.round(subtotal * 0.02) : 0;
        const total = subtotal + delivery + vat + processingFee;

        document.getElementById('invoice-content').innerHTML = `
            <!-- Company Header -->
            <div class="text-center mb-4">
                <h3 class="text-primary">নাগরীবাসী এক্সপ্রেস</h3>
                <p class="text-muted">আপনার শহরের সবচেয়ে নির্ভরযোগ্য ডেলিভারি সেবা</p>
                <hr>
            </div>

            <!-- Order Info -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>অর্ডার তথ্য</h6>
                    <p><strong>অর্ডার ID:</strong> ${orderData.id}</p>
                    <p><strong>তারিখ:</strong> ${orderData.date}</p>
                    <p><strong>পেমেন্ট:</strong> ${getPaymentMethodName(orderData.payment)}</p>
                </div>
                <div class="col-md-6">
                    <h6>গ্রাহক তথ্য</h6>
                    <p><strong>নাম:</strong> ${orderData.customer.name}</p>
                    <p><strong>ফোন:</strong> ${orderData.customer.phone}</p>
                    <p><strong>এলাকা:</strong> ${orderData.customer.area}</p>
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="mb-4">
                <h6>ডেলিভারি ঠিকানা</h6>
                <p class="border p-3 bg-light">${orderData.customer.address}</p>
                <p><strong>ডেলিভারি সময়:</strong> ${orderData.customer.time}</p>
            </div>

            <!-- Order Items -->
            <div class="mb-4">
                <h6>অর্ডার আইটেম</h6>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>পণ্য</th>
                                <th>পরিমাণ</th>
                                <th>দর</th>
                                <th>মোট</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orderData.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>৳ ${item.price}</td>
                                    <td>৳ ${item.price * item.quantity}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="row">
                <div class="col-md-6 offset-md-6">
                    <div class="border p-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>মোট পণ্য:</span>
                            <span>৳ ${subtotal}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>ডেলিভারি চার্জ:</span>
                            <span>৳ ${delivery}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>ভ্যাট (৫%):</span>
                            <span>৳ ${vat}</span>
                        </div>
                        ${processingFee > 0 ? `
                            <div class="d-flex justify-content-between mb-2">
                                <span>প্রসেসিং ফি:</span>
                                <span>৳ ${processingFee}</span>
                            </div>
                        ` : ''}
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>মোট পরিমাণ:</span>
                            <span>৳ ${total}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Instructions -->
            ${orderData.payment !== 'cod' ? `
                <div class="alert alert-info mt-4">
                    <h6>পেমেন্ট নির্দেশনা</h6>
                    <p>অনুগ্রহ করে ${getPaymentMethodName(orderData.payment)} এর মাধ্যমে পেমেন্ট করুন এবং ট্রানজেকশন ID সংরক্ষণ করুন।</p>
                </div>
            ` : `
                <div class="alert alert-success mt-4">
                    <h6>পেমেন্ট নির্দেশনা</h6>
                    <p>আপনার অর্ডার ক্যাশ অন ডেলিভারি হিসেবে নিবন্ধিত হয়েছে। ডেলিভারি সময়ে নগদ পেমেন্ট করুন।</p>
                </div>
            `}

            <!-- Thank You Message -->
            <div class="text-center mt-4">
                <h5 class="text-success">ধন্যবাদ! আপনার অর্ডার গ্রহণ করা হয়েছে</h5>
                <p class="text-muted">আমাদের ডেলিভারি এজেন্ট শীঘ্রই আপনার সাথে যোগাযোগ করবে</p>
            </div>
        `;
    }

    function getPaymentMethodName(method) {
        const methods = {
            'cod': 'ক্যাশ অন ডেলিভারি',
            'bkash': 'bKash',
            'nagad': 'Nagad',
            'rocket': 'Rocket'
        };
        return methods[method] || method;
    }
</script>

<style>
    @media print {
        .btn, .card-header {
            display: none !important;
        }
        .card {
            border: none !important;
            box-shadow: none !important;
        }
    }
</style>
{% endblock %}
